<odoo>

    <record id="create_donation_invoice" model="ir.actions.server">
            <field name="name">=> Crear Factura Donaci√≥n</field>
            <field name="model_id" ref="model_account_move"/>
            <field name="binding_model_id" ref="model_account_move"/>
            <field name="state">code</field>
            <field name="code">

if (not record.donation_invoice_id.id) and (record.move_type == 'in_invoice):
    donation_journal = env.company.donation_journal_id
    donation_product = env.company.donation_product_id
    if not donation_journal.id or not donation_product.id:
        raise Warning('Cumpliemnta en la ficha de empresa diario y producto de donaciones.')
    donation_invoice = env['account.move'].create({'move_type':'out_invoice',
                                                      'journal_id':donation_journal.id,
                                                      'partner_id':record.partner_id})
    record['donation_invoice_id'] = donation_invoice.id

    for li in record.invoice_line_ids:
        if li.price_subtotal != 0:
            name = " (" + str(li.quantity) + " x " + li.product_id.name +")"
            donation_invoice['line_ids'] = [(0,0,{
                    'product_id':donation_product.id,
                    'name': donation_product.name + name,
                    'credit': abs(li.price_subtotal),
                    'account_id': donation_product.property_account_expense_id.id,
                    'analytic_account_id':li.analytic_account_id.id,
                    'partner_id': record.partner_id.id
                }), (0, 0, {
                    'name': record.name or '/',
                    'debit': abs(li.price_subtotal),
                    'account_id': record.partner_id.property_account_receivable_id.id,
                    'partner_id': record.partner_id.id,
                    'exclude_from_invoice_tab':True
                })]

            </field>
        </record>

</odoo>


